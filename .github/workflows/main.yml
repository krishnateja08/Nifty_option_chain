name: Nifty 50 Analysis + GitHub Pages

on:
  schedule:
  - cron: '37 3 * * 1-5'          # 09:07 AM IST
  - cron: '4,31,58 4 * * 1-5'    # 09:34, 10:01, 10:28
  - cron: '25,52 5 * * 1-5'      # 10:55, 11:22
  - cron: '19,46 6 * * 1-5'      # 11:49, 12:16
  - cron: '13,40 7 * * 1-5'      # 12:43, 01:10
  - cron: '7,34 8 * * 1-5'       # 01:37, 02:04
  - cron: '1,28,55 9 * * 1-5'    # 02:31, 02:58, 03:25
  - cron: '22 10 * * 1-5'        # 03:52 PM IST
  workflow_dispatch:

# Required permissions
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  analyze-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install curl_cffi pandas yfinance openpyxl
      
      - name: Run Analysis
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          RECIPIENT_EMAIL_1: ${{ secrets.RECIPIENT_EMAIL_1 }}
          RECIPIENT_EMAIL_2: ${{ secrets.RECIPIENT_EMAIL_2 }}
        run: |
          python nifty50_option_analysis.py
          echo "âœ… Analysis complete"
          ls -la index.html
      
      # Deploy using peaceiris/actions-gh-pages (easiest method)
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          keep_files: false
          commit_message: "ðŸ“Š Update Nifty Report - ${{ github.event.head_commit.message }}"
      
      - name: Show URL
        run: |
          echo "=============================================="
          echo "âœ… Deployed successfully!"
          echo "=============================================="
          echo "ðŸ”— Your report is live at:"
          echo "   https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "=============================================="
