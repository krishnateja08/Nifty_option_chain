name: Nifty 50 Analysis + GitHub Pages

on:
  schedule:
   - cron: '7,31,55 8,10,12,14 * * 1-5'  # 08:07, 08:31, 08:55... up to 14:55
   - cron: '19,43 9,11,13,15 * * 1-5'    # 09:19, 09:43... up to 15:43
   - cron: '0 16 * * 1-5'               # 16:00 (4:00 PM)
  workflow_dispatch:

# Required permissions
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  analyze-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install curl_cffi pandas yfinance openpyxl
      
      - name: Run Analysis
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          RECIPIENT_EMAIL_1: ${{ secrets.RECIPIENT_EMAIL_1 }}
          RECIPIENT_EMAIL_2: ${{ secrets.RECIPIENT_EMAIL_2 }}
        run: |
          python nifty50_option_analysis.py
          echo "âœ… Analysis complete"
          ls -la index.html
      
      # Deploy using peaceiris/actions-gh-pages (easiest method)
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          keep_files: false
          commit_message: "ðŸ“Š Update Nifty Report - ${{ github.event.head_commit.message }}"
      
      - name: Show URL
        run: |
          echo "=============================================="
          echo "âœ… Deployed successfully!"
          echo "=============================================="
          echo "ðŸ”— Your report is live at:"
          echo "   https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "=============================================="
