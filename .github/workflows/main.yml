name: Nifty 50 Analysis + GitHub Pages

on:
  schedule:
    # Runs at 04:08, 04:35 (IST: 09:38, 10:05)
    - cron: '8,35 4 * * 1-5'
    # Runs at 05:02, 05:29, 05:56 (IST: 10:32, 10:59, 11:26)
    - cron: '2,29,56 5 * * 1-5'
    # Runs at 06:23, 06:50 (IST: 11:53, 12:20)
    - cron: '23,50 6 * * 1-5'
    # Runs at 07:17, 07:44 (IST: 12:47, 13:14)
    - cron: '17,44 7 * * 1-5'
    # Runs at 08:11, 08:38 (IST: 13:41, 14:08)
    - cron: '11,38 8 * * 1-5'
    # Runs at 09:05, 09:32, 09:59 (IST: 14:35, 15:02, 15:29)
    - cron: '5,32,59 9 * * 1-5'
    # Runs at 10:26, 10:30 (IST: 15:56, 16:00)
    - cron: '26,30 10 * * 1-5'
  workflow_dispatch:

# Required permissions
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  analyze-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install curl_cffi pandas yfinance openpyxl
      
      - name: Run Analysis
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          RECIPIENT_EMAIL_1: ${{ secrets.RECIPIENT_EMAIL_1 }}
          RECIPIENT_EMAIL_2: ${{ secrets.RECIPIENT_EMAIL_2 }}
        run: |
          python nifty50_option_analysis.py
          echo "âœ… Analysis complete"
          ls -la index.html
      
      # Deploy using peaceiris/actions-gh-pages (easiest method)
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          keep_files: false
          commit_message: "ðŸ“Š Update Nifty Report - ${{ github.event.head_commit.message }}"
      
      - name: Show URL
        run: |
          echo "=============================================="
          echo "âœ… Deployed successfully!"
          echo "=============================================="
          echo "ðŸ”— Your report is live at:"
          echo "    https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "=============================================="
